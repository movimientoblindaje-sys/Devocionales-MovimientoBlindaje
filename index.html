<!-- 
  Reproductor de Audio Devocional Diario
  Funcionalidad:
    - Rotación diaria de 3 audios (Desayuno, Almuerzo, Cena)
    - Persistencia de estado (índice, volumen, tiempo) en Firestore.
    - Botones de avance/retroceso de 5 segundos.
    - Compartir enlace directo al audio actual (vía parámetro URL).
--><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devocional Diario - Reproductor</title>
    <!-- Carga de Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter para la estética --><style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffc61a; /* Fondo amarillo */
        }
        /* Estilos personalizados para la barra de progreso */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }

        /* Estilo para el logo grande y rectangular */
        .large-logo {
            max-width: 200px; /* Ajusta el ancho máximo según necesites */
            height: auto; /* Mantiene la proporción original */
            object-fit: contain; /* Asegura que la imagen completa sea visible */
            border-radius: 0; /* Asegura que sea rectangular */
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <!-- Logo y Título --><header class="text-center mb-8">
        <!-- Logo con placeholder de fallback. Se quitó rounded-full y se ajustó el onerror --><img id="logo-img" 
             src="logo-blindaje.png" 
             onerror="this.src='https://placehold.co/200x100/000000/FFFFFF?text=BLINDAJE+LOGO'"
             alt="Logo Blindaje" 
             class="mx-auto large-logo shadow-lg mb-4">
        
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider uppercase drop-shadow-lg">Devocional diario</h1>
        <p id="devotion-day-info" class="text-sm font-semibold text-gray-800 mt-2"></p>
    </header>

    <!-- Contenedor de Tarjetas: Apiladas verticalmente (flex-col) --><main id="card-container" class="flex flex-col gap-6 max-w-4xl mx-auto">
        
        <!-- Tarjeta 1: Reproductor Principal --><section id="player-card" class="bg-gray-900 text-white p-6 md:p-8 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Reproductor de Audio</h2>

            <div class="space-y-4">
                <!-- Información de la Pista Actual --><div class="text-center mb-6">
                    <p id="track-name" class="text-2xl font-semibold truncate">Cargando...</p>
                    <p id="track-artist" class="text-sm text-gray-400">Blindaje Espiritual</p>
                </div>

                <!-- Barra de Progreso --><div class="flex items-center space-x-2">
                    <span id="current-time" class="text-sm w-12 text-left">0:00</span>
                    <input type="range" id="seek-bar" value="0" min="0" max="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                    <span id="total-time" class="text-sm w-12 text-right">0:00</span>
                </div>
                
                <!-- Controles de Reproducción --><div class="flex justify-center items-center space-x-4 md:space-x-6 pt-4">
                    
                    <!-- Retroceder 5s (icono más grande) --><button id="skip-backward-btn" class="text-white hover:text-yellow-400 p-2 rounded-full transition-all" aria-label="Retroceder 5 segundos">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h3a1 1 0 100-2H7zm4-2.586l3 3a1 1 0 010 1.414l-3 3A1 1 0 0110 12V8a1 1 0 011.414-.707z" clip-rule="evenodd"></path></svg>
                    </button>

                    <!-- Anterior (icono más grande) --><button id="prev-btn" class="text-white hover:text-yellow-400 p-2 rounded-full transition-all" aria-label="Pista Anterior">
                        <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm-5-8a1 1 0 011-1h4.586l-1.293-1.293a1 1 0 011.414-1.414l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L10.586 11H6a1 1 0 01-1-1z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    </button>

                    <!-- Reproducir / Pausar (icono aún más grande) --><button id="play-pause-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 p-4 rounded-full shadow-lg transition-all transform hover:scale-105" aria-label="Reproducir o Pausar">
                        <svg id="play-icon" class="w-12 h-12" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                        <svg id="pause-icon" class="w-12 h-12 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h1a1 1 0 011 1v4a1 1 0 01-1 1H8a1 1 0 01-1-1V8zm5-1a1 1 0 00-1 1v4a1 1 0 001 1h1a1 1 0 001-1V8a1 1 0 00-1-1h-1z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    </button>

                    <!-- Siguiente (icono más grande) --><button id="next-btn" class="text-white hover:text-yellow-400 p-2 rounded-full transition-all" aria-label="Pista Siguiente">
                        <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    </button>
                    
                    <!-- Avanzar 5s (icono más grande) --><button id="skip-forward-btn" class="text-white hover:text-yellow-400 p-2 rounded-full transition-all" aria-label="Avanzar 5 segundos">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3-9a1 1 0 00-2 0v3a1 1 0 102 0V9zM7 8a1 1 0 011.414-.707l3 3a1 1 0 010 1.414l-3 3A1 1 0 017 12V8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>

                <!-- Botón de Compartir Audio --><button id="share-audio-btn" class="w-full bg-yellow-500/20 text-yellow-300 hover:bg-yellow-500/40 font-semibold py-3 px-4 rounded-lg mt-4 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M13 13h3a3 3 0 000-6h-.025A5.56 5.56 0 0016 6.5 6.5 6.5 0 009.75 4.148 5.485 5.485 0 0110 6.5C10 9.047 8.163 11.233 5.766 11.758A7.03 7.03 0 0010 19a7.001 7.001 0 006.338-3.993 4.974 4.974 0 00-.776-3.873zM7 10a3 3 0 100-6 3 3 0 000 6z"></path></svg>
                    Compartir Audio
                </button>

                <!-- Control de Volumen --><div class="flex items-center space-x-2 pt-4">
                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.673 8.327a1 1 0 010 3.346A5.008 5.008 0 0016 10a5.008 5.008 0 00-1.327-3.346z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
                    <input type="range" id="volume-bar" value="100" min="0" max="100" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer range-sm">
                    <span id="volume-display" class="text-sm w-8 text-right text-gray-400">100%</span>
                </div>
            </div>
        </section>

        <!-- Tarjeta 2: Audios del Día (Los 3 que rotan diariamente) --><section id="daily-card" class="bg-gray-900 text-white p-6 md:p-8 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Audios de Hoy</h2>
            <ul id="daily-list" class="divide-y divide-gray-800">
                <!-- Los audios del día se renderizarán aquí --></ul>
        </section>

        <!-- Tarjeta 3: Audios Anteriores (Archivados por rotación) --><section id="archive-card" class="bg-gray-900 text-white p-6 md:p-8 rounded-xl shadow-2xl">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Audios Anteriores</h2>
            <ul id="archive-list" class="divide-y divide-gray-800">
                <!-- Los audios anteriores se renderizarán aquí --></ul>
        </section>
        
        <!-- Indicador de Usuario (Necesario para Firestore) --><div class="text-center text-xs text-white/50 mt-4">
            ID de Usuario: <span id="user-id">Cargando...</span>
        </div>

    </main>

    <!-- Scripts de Firebase y Lógica del Reproductor --><script type="module">
        // Importaciones de Firebase (necesarias para la persistencia)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // setLogLevel('Debug'); // Descomentar para ver logs detallados de Firebase

        // --- Configuración de Rotación Diaria ---
        const TRACKS_PER_DAY = 3;
        // La fecha de inicio del devocional. Asumimos el 2025-11-21 es el Día 1.
        const START_DATE = new Date('2025-11-21T00:00:00'); 
        
        // Variables Globales
        let audio;
        let tracks = [];
        let currentTrackIndex = 0;
        let isPlaying = false;
        let auth;
        let db;
        let userId = 'default-user';
        let appId;
        let currentStartIndex = 0; // Índice de la primera pista de "Audios de Hoy"
        
        // --- Configuraciones Iniciales ---

        // 1. Configuración de Firebase y App ID
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        appId = typeof __app_id !== 'undefined' ? __app_id : 'devocional-diario-app';
        
        const DB_COLLECTION = 'playlist_data';
        const DB_DOC_ID = 'user_state';
        
        // 2. Definición de la Lista de Reproducción (URLs de Archive.org)
        const URLS = [
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-1-1-al-5.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-1-6-al-9.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-1-9-al-20.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-2-1-al-7.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-2-8-al-11.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-2-12-al-17.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-2-18-al-29.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-3-1-al-6.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-3-7-al-13.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-3-14-al-22.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-4-1-al-11.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-5-1-al-6.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-5-7-al-14.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-6-1-al-4.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-6-5-al-8.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-6-9-al-11.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-6-12-al-17.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-7-1-al-8.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-7-9-al-17.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-8-1-al-5.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-8-6-al-13.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-9-1-al-12.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-9-13-al-21.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-10-1-al-11.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-11-1-al-6.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-11-7-al-14.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-11-15-al-19.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-12-1-al-12.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-12-13-al-18.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-13-1-al-10.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-13-11-al-18.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-14-1-al-5.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-14-6-al-13.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-14-14-al-20.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-15-1-al-4.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-15-5-al-8.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-16-1-al-9.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-16-10-al-14.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-16-15-al-21.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-17-1-al-6.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-17-7-al-13.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-17-14-al-18.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-18-1-al-8.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-18-9-al-20.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-18-21-al-24.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-19-1-al-10.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-apocalipsis/Libro-de-Apocalipsis-19-11-al-21.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-20-1-al-6.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-20-7-al-10.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-20-11-al-15.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-21-1-al-7.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-21-8-al-27.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-22-1-al-6.mp3",
            "https://archive.org/download/libro-de-apocalipsis/Libro-de-Apocalipsis-22-7-al-21.mp3"
        ];

        // Función para extraer el nombre de la URL
        function extractTrackName(url) {
            const parts = url.split('/');
            const filename = parts[parts.length - 1].replace(/.mp3$/, '');
            const nameMatch = filename.match(/Libro-de-Apocalipsis-(\d+)-(\d+)-al-(\d+)/);
            if (nameMatch) {
                // Formato: Apocalipsis [Capítulo]:[Versículo Inicial]-[Versículo Final]
                return `Apocalipsis ${nameMatch[1]}:${nameMatch[2]}-${nameMatch[3]}`;
            }
            return filename.replace(/-/g, ' ');
        }
        
        // Estructura base de las pistas
        const ALL_TRACKS = URLS.map((url) => ({ name: extractTrackName(url), url }));


        // --- Elementos del DOM ---
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        // Nuevos botones de skip
        const skipBackwardBtn = document.getElementById('skip-backward-btn');
        const skipForwardBtn = document.getElementById('skip-forward-btn');
        const shareAudioBtn = document.getElementById('share-audio-btn');

        const trackNameEl = document.getElementById('track-name');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const seekBar = document.getElementById('seek-bar');
        const volumeBar = document.getElementById('volume-bar');
        const volumeDisplay = document.getElementById('volume-display');
        const dailyListEl = document.getElementById('daily-list');
        const archiveListEl = document.getElementById('archive-list');
        const userIdEl = document.getElementById('user-id');
        const devotionDayInfoEl = document.getElementById('devotion-day-info');

        // --- Funciones de Utilidad ---

        /** Obtiene el índice de pista si viene como parámetro en la URL. */
        function getTrackIndexFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const index = urlParams.get('trackIndex');
            
            if (index !== null) {
                const numIndex = parseInt(index, 10);
                // Validación estricta
                if (!isNaN(numIndex) && numIndex >= 0 && numIndex < ALL_TRACKS.length) {
                    return numIndex;
                }
            }
            return null;
        }


        /** Calcula el índice inicial de los audios de hoy basado en la fecha. */
        function calculateCurrentDayIndex() {
            const today = new Date();
            // Creamos una fecha solo con el día para ignorar la hora
            const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            
            // Calculamos la diferencia en milisegundos
            const timeDiff = todayDateOnly.getTime() - START_DATE.getTime();
            
            // Calculamos los días transcurridos (puede ser negativo si la fecha de inicio es futura)
            let daysElapsed = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

            // Si daysElapsed es negativo, el devocional aún no comienza (usamos el día 0)
            if (daysElapsed < 0) daysElapsed = 0;

            const dayIndex = daysElapsed + 1;
            const startIndex = daysElapsed * TRACKS_PER_DAY;

            // Asegura que el índice no exceda el límite superior de la lista completa
            if (startIndex >= ALL_TRACKS.length) {
                const maxIndex = Math.floor((ALL_TRACKS.length - 1) / TRACKS_PER_DAY) * TRACKS_PER_DAY;
                devotionDayInfoEl.textContent = `Devocional Terminado (Día Final)`;
                return maxIndex;
            }
            
            devotionDayInfoEl.textContent = `Día de Devocional: ${dayIndex}`;

            return startIndex;
        }

        /** Formatea segundos a MM:SS */
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            // FIX: Template expression was incomplete, causing SyntaxError.
            // Solución: Usar un operador ternario para agregar un '0' si los segundos son < 10.
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }
        
        // --- Lógica del Reproductor ---

        function loadTrack(index) {
            if (index < 0 || index >= ALL_TRACKS.length) {
                console.error("Índice de pista fuera de rango.");
                return;
            }

            currentTrackIndex = index;
            const track = ALL_TRACKS[currentTrackIndex];
            
            // Si ya existe un audio, detenemos y limpiamos
            if (audio) {
                audio.pause();
                audio.src = '';
            }

            audio = new Audio(track.url);
            audio.volume = parseFloat(volumeBar.value) / 100;
            trackNameEl.textContent = track.name;
            currentTimeEl.textContent = '0:00';
            totalTimeEl.textContent = '0:00';
            seekBar.value = 0;
            
            updatePlayPauseButton(false);
            highlightCurrentTrack();

            // Guardar estado al cambiar de pista
            saveUserState(audio.currentTime);

            // Event listeners específicos del audio (se deben añadir después de crear el objeto Audio)
            audio.addEventListener('loadedmetadata', () => {
                const totalSeconds = audio.duration;
                totalTimeEl.textContent = formatTime(totalSeconds);
                seekBar.max = totalSeconds;
                
                // Intentar recuperar el tiempo de la pista guardada si no es un enlace compartido
                if (getTrackIndexFromUrl() === null) {
                    loadUserState();
                }
            });

            audio.addEventListener('timeupdate', () => {
                if (!seekBar.isDragging) {
                    seekBar.value = audio.currentTime;
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                }
            });

            audio.addEventListener('ended', () => {
                playNextTrack();
            });
            
            // Autoplay solo si venimos de un estado de reproducción previo (a menos que sea el inicio)
            if (isPlaying) {
                audio.play().catch(e => console.error("Error al iniciar la reproducción automáticamente:", e));
            }
        }

        function updatePlayPauseButton(isCurrentlyPlaying) {
            if (isCurrentlyPlaying) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                isPlaying = true;
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                isPlaying = false;
            }
        }

        function togglePlayPause() {
            if (audio.paused || audio.ended) {
                audio.play().then(() => updatePlayPauseButton(true)).catch(e => {
                    console.error("Error al reproducir el audio:", e);
                    // Mostrar un mensaje de error simple si la reproducción falla (por ejemplo, autoplay bloqueado)
                    showUserMessage("Presiona Play de nuevo. El navegador bloqueó la reproducción automática.");
                });
            } else {
                audio.pause();
                updatePlayPauseButton(false);
                saveUserState(audio.currentTime);
            }
        }

        function playNextTrack() {
            let nextIndex = (currentTrackIndex + 1);
            if (nextIndex >= ALL_TRACKS.length) {
                nextIndex = 0; // Vuelve al inicio
            }
            loadTrack(nextIndex);
            if (isPlaying) {
                audio.play();
            }
        }

        function playPrevTrack() {
            let prevIndex = (currentTrackIndex - 1);
            if (prevIndex < 0) {
                prevIndex = ALL_TRACKS.length - 1; // Vuelve al final
            }
            loadTrack(prevIndex);
            if (isPlaying) {
                audio.play();
            }
        }

        function skipTime(seconds) {
            if (audio) {
                audio.currentTime += seconds;
                // Asegurar que no se salga de los límites
                if (audio.currentTime < 0) audio.currentTime = 0;
                if (audio.currentTime > audio.duration) audio.currentTime = audio.duration;
                saveUserState(audio.currentTime);
            }
        }

        function handleSeekChange() {
            // Guardar si se detiene el arrastre o si el audio está cargado
            if (audio && audio.readyState > 0) {
                audio.currentTime = parseFloat(seekBar.value);
                saveUserState(audio.currentTime);
            }
        }

        function handleVolumeChange() {
            const volume = parseFloat(volumeBar.value) / 100;
            if (audio) {
                audio.volume = volume;
            }
            volumeDisplay.textContent = `${volumeBar.value}%`;
            // No guardar el volumen en Firestore ya que no es vital para la posición de reproducción
        }
        
        // --- Renderizado de Listas y Navegación ---

        function highlightCurrentTrack() {
            document.querySelectorAll('.track-item').forEach(li => {
                li.classList.remove('bg-yellow-500/10', 'border-yellow-500');
                li.classList.add('hover:bg-gray-700/50', 'border-gray-800');
            });
            const activeEl = document.getElementById(`track-${currentTrackIndex}`);
            if (activeEl) {
                activeEl.classList.remove('hover:bg-gray-700/50', 'border-gray-800');
                activeEl.classList.add('bg-yellow-500/10', 'border-yellow-500');
            }
        }

        /** Renderiza una pista individual en una lista. */
        function renderTrack(track, index, container, trackDay) {
            const li = document.createElement('li');
            li.id = `track-${index}`;
            li.className = 'track-item flex justify-between items-center py-3 px-2 border-b transition-colors cursor-pointer border-gray-800 hover:bg-gray-700/50';
            li.setAttribute('data-index', index);
            
            let label = track.name;
            
            // Asignar etiquetas de Desayuno, Almuerzo, Cena solo a las pistas de "Hoy"
            if (trackDay) {
                 const partIndex = index % TRACKS_PER_DAY; // 0, 1, 2
                 const parts = ["Desayuno", "Almuerzo", "Cena"];
                 label = `${parts[partIndex]}: ${track.name}`;
            }

            li.innerHTML = `
                <span class="text-sm font-medium truncate">${label}</span>
                <button class="text-gray-400 hover:text-yellow-500 p-1 rounded-full transition-colors" data-index="${index}" aria-label="Reproducir ${label}">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                </button>
            `;
            
            li.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                if (index !== currentTrackIndex) {
                    loadTrack(index);
                    togglePlayPause(); // Iniciar reproducción
                } else {
                    togglePlayPause();
                }
            });
            // Permitir clic en el LI para iniciar reproducción si no es el actual
             li.addEventListener('click', () => {
                if (index !== currentTrackIndex) {
                    loadTrack(index);
                    togglePlayPause(); // Iniciar reproducción
                } else {
                    togglePlayPause();
                }
            });

            container.appendChild(li);
        }

        function renderPlaylists() {
            // Limpiar listas
            dailyListEl.innerHTML = '';
            archiveListEl.innerHTML = '';

            const totalTracks = ALL_TRACKS.length;
            
            // Audios de Hoy
            // Rango: [currentStartIndex, currentStartIndex + TRACKS_PER_DAY - 1]
            for (let i = currentStartIndex; i < currentStartIndex + TRACKS_PER_DAY && i < totalTracks; i++) {
                renderTrack(ALL_TRACKS[i], i, dailyListEl, true); // true para indicar que es pista diaria
            }

            // Audios Anteriores (Desde el inicio hasta justo antes de la lista de hoy)
            // Rango: [0, currentStartIndex - 1]
            for (let i = 0; i < currentStartIndex && i < totalTracks; i++) {
                renderTrack(ALL_TRACKS[i], i, archiveListEl, false);
            }

            highlightCurrentTrack();
        }

        /** Muestra un mensaje temporal al usuario. */
        function showUserMessage(message) {
            // Implementación simple: usar un div flotante o loguear
            console.log("Mensaje al Usuario:", message);
            const playerCard = document.getElementById('player-card');
            let msgEl = document.getElementById('user-msg-temp');
            if (!msgEl) {
                 msgEl = document.createElement('div');
                 msgEl.id = 'user-msg-temp';
                 msgEl.className = 'absolute top-0 left-0 right-0 bg-yellow-500 text-gray-900 font-bold p-3 rounded-t-xl text-center transition-opacity duration-300 opacity-0';
                 playerCard.style.position = 'relative'; // Asegura que el mensaje se posicione correctamente
                 playerCard.prepend(msgEl);
            }
            msgEl.textContent = message;
            msgEl.classList.remove('opacity-0');
            msgEl.classList.add('opacity-100');

            setTimeout(() => {
                msgEl.classList.remove('opacity-100');
                msgEl.classList.add('opacity-0');
            }, 3000);
        }

        // --- Persistencia con Firebase Firestore (Privada) ---
        
        /** Obtiene la referencia al documento de estado del usuario. */
        function getUserStateDocRef() {
            // path: /artifacts/{appId}/users/{userId}/{collectionName}/{docId}
            return doc(db, 'artifacts', appId, 'users', userId, DB_COLLECTION, DB_DOC_ID);
        }

        /** Guarda el estado actual de reproducción en Firestore. */
        async function saveUserState(time) {
            if (!db || !userId || time === undefined) return;
            
            const state = {
                currentTrackIndex: currentTrackIndex,
                currentTime: time,
                volume: audio ? audio.volume : parseFloat(volumeBar.value) / 100,
                lastUpdated: new Date().toISOString()
            };

            try {
                await setDoc(getUserStateDocRef(), state, { merge: true });
                // console.log("Estado guardado:", state);
            } catch (error) {
                console.error("Error al guardar el estado en Firestore:", error);
            }
        }

        /** Carga el estado inicial del usuario. */
        function loadUserState() {
            if (!db || !userId) return;
            
            const docRef = getUserStateDocRef();
            
            // Escucha en tiempo real para mantener la posición sincronizada
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const state = docSnap.data();
                    console.log("Estado cargado:", state);
                    
                    const savedIndex = state.currentTrackIndex;
                    const savedTime = state.currentTime;
                    const savedVolume = state.volume;

                    // 1. Cargar Pista (si ha cambiado)
                    if (savedIndex !== undefined && savedIndex !== currentTrackIndex) {
                        loadTrack(savedIndex);
                        // No reproducir automáticamente aquí, solo actualizar el índice.
                        // La reproducción se maneja con el toggle/autoplay.
                    }

                    // 2. Aplicar Volumen
                    if (savedVolume !== undefined) {
                        const volumeValue = Math.round(savedVolume * 100);
                        volumeBar.value = volumeValue;
                        handleVolumeChange(); // Aplica el volumen al objeto Audio y al display
                    }

                    // 3. Aplicar Tiempo (solo si la pista es la misma y no estamos arrastrando)
                    if (savedIndex === currentTrackIndex && savedTime !== undefined) {
                        // Solo actualiza el tiempo si la diferencia es significativa
                        if (audio && Math.abs(audio.currentTime - savedTime) > 1) {
                             // console.log(`Restaurando tiempo a: ${formatTime(savedTime)}`);
                             audio.currentTime = savedTime;
                        }
                    }
                } else {
                    console.log("No se encontró estado guardado. Usando defaults.");
                    // Si no hay estado, cargamos la pista por defecto
                    loadTrack(currentTrackIndex);
                }
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
            });
        }
        
        // --- Eventos y Inicialización ---

        // Configurar botones de control
        playPauseBtn.addEventListener('click', togglePlayPause);
        prevBtn.addEventListener('click', playPrevTrack);
        nextBtn.addEventListener('click', playNextTrack);
        skipBackwardBtn.addEventListener('click', () => skipTime(-5));
        skipForwardBtn.addEventListener('click', () => skipTime(5));

        // Eventos para la barra de búsqueda
        seekBar.addEventListener('change', handleSeekChange);
        // Marcar que el usuario está arrastrando para detener la actualización automática
        seekBar.addEventListener('mousedown', () => seekBar.isDragging = true);
        seekBar.addEventListener('mouseup', () => seekBar.isDragging = false);

        // Eventos para el volumen
        volumeBar.addEventListener('input', handleVolumeChange);

        // Evento de Compartir
        shareAudioBtn.addEventListener('click', () => {
            if (currentTrackIndex !== -1) {
                // Generar URL con el índice de la pista
                const url = new URL(window.location.href);
                url.searchParams.set('trackIndex', currentTrackIndex);
                
                // Usar la API del portapapeles (navigator.clipboard) o fallback
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(url.toString()).then(() => {
                        showUserMessage("¡Enlace copiado al portapapeles!");
                    }).catch(err => {
                        console.error('Error al copiar el texto: ', err);
                        // Fallback (menos amigable en algunos navegadores/iframes)
                        try {
                            const tempInput = document.createElement('input');
                            document.body.appendChild(tempInput);
                            tempInput.value = url.toString();
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showUserMessage("¡Enlace copiado al portapapeles! (Método alternativo)");
                        } catch (e) {
                            showUserMessage("Error: No se pudo copiar el enlace automáticamente.");
                        }
                    });
                } else {
                     showUserMessage("Tu navegador no soporta la función de copia automática. El enlace generado es: " + url.toString());
                }
            } else {
                showUserMessage("Por favor, selecciona una pista primero.");
            }
        });

        // --- Función de Inicio ---
        async function initializeApp() {
            // 1. Inicializar Firebase
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Persistir la sesión (opcional, pero útil)
            await setPersistence(auth, browserLocalPersistence);

            // 2. Autenticación
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error de autenticación Firebase:", error);
                // Si la autenticación falla, usamos un ID aleatorio temporal
                userId = crypto.randomUUID(); 
            }

            // 3. Obtener el ID de usuario y actualizar la UI
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdEl.textContent = userId;
                    
                    // 4. Calcular el índice de rotación
                    currentStartIndex = calculateCurrentDayIndex();
                    
                    // 5. Comprobar si hay un índice en la URL (enlace compartido)
                    const urlIndex = getTrackIndexFromUrl();
                    if (urlIndex !== null) {
                        currentTrackIndex = urlIndex;
                        // Si viene de un enlace, renderizamos y cargamos, pero no cargamos el estado guardado aún.
                        renderPlaylists(); 
                        loadTrack(currentTrackIndex);
                        showUserMessage(`Cargada pista #${urlIndex + 1} desde enlace compartido.`);
                        // Intentar reproducir automáticamente si se carga desde URL
                        audio.play().then(() => updatePlayPauseButton(true)).catch(e => {
                            // Silently fail or show a message if autoplay is blocked
                        });
                        
                    } else {
                        // Si NO viene de un enlace, cargar el estado guardado (esto llama a loadTrack dentro)
                        renderPlaylists(); // Renderiza con el índice por defecto
                        loadUserState();
                    }

                } else {
                    console.error("Usuario no autenticado, operando con ID por defecto/aleatorio.");
                    userIdEl.textContent = userId; // Mostrar ID aleatorio
                    
                    // Aún necesitamos calcular el día y renderizar las listas
                    currentStartIndex = calculateCurrentDayIndex();
                    renderPlaylists();
                    
                    // Cargar la primera pista de hoy como default
                    loadTrack(currentStartIndex);
                }
            });
        }

        initializeApp();

    </script>
</body>
</html>
