<!-- 
  Reproductor de Audio Devocional Diario - Edición 1 y 2 Samuel
  Funcionalidad:
    - Rotación diaria de 3 audios (Desayuno, Almuerzo, Cena)
    - Iconos modernos y estética Blindaje (Amarillo/Negro)
    - El historial comienza vacío hoy.
-->
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devocional Diario - 1 y 2 Samuel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffc61a;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
        }

        .large-logo {
            height: auto;
            max-height: 250px;
            width: auto;
            max-width: 100%;
        }
        
        .play-pulse {
            animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-ring {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
    </style>
</head>

<body class="p-4 md:p-8 min-h-screen">

    <header class="text-center mb-8">
        <!-- Restaurado el Logo original con la ruta del archivo local -->
        <img id="logo-img" src="logo-blindaje.png" alt="Logo Blindaje"
            class="mx-auto large-logo shadow-2xl mb-6 rounded-lg">

        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider uppercase drop-shadow-lg">Devocional diario</h1>
        <p id="devotion-day-info" class="text-sm font-semibold text-gray-800 mt-2 italic">Iniciando serie: 1 Samuel</p>
    </header>

    <main id="card-container" class="flex flex-col gap-6 max-w-4xl mx-auto">

        <!-- Reproductor Principal -->
        <section id="player-card" class="bg-gray-900 text-white p-6 md:p-10 rounded-2xl shadow-2xl border border-white/5">
            <h2 class="text-xs uppercase tracking-[0.2em] font-black text-yellow-500 mb-6 text-center opacity-80">Reproductor Blindaje</h2>

            <div class="space-y-6">
                <div class="text-center mb-8">
                    <p id="track-name" class="text-2xl md:text-3xl font-bold truncate px-2 text-yellow-500">Cargando...</p>
                    <p id="track-artist" class="text-sm text-gray-400 font-medium mt-1 uppercase tracking-widest">1 Samuel • Movimiento Blindaje</p>
                </div>

                <!-- Barra de Progreso -->
                <div class="space-y-2">
                    <div class="flex items-center space-x-3">
                        <span id="current-time" class="text-xs font-mono w-10 opacity-60">0:00</span>
                        <input type="range" id="seek-bar" value="0" min="0" max="100"
                            class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg accent-yellow-500">
                        <span id="total-time" class="text-xs font-mono w-10 opacity-60">0:00</span>
                    </div>
                </div>

                <!-- Controles de Reproducción -->
                <div class="flex justify-center items-center space-x-4 md:space-x-8 py-4">

                    <!-- Retroceder 5s -->
                    <button id="skip-backward-btn" class="text-gray-500 hover:text-yellow-500 transition-colors" title="Retroceder 5s">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.334 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z" />
                        </svg>
                    </button>

                    <!-- Anterior -->
                    <button id="prev-btn" class="text-gray-400 hover:text-white transition-all group">
                        <svg class="w-10 h-10 group-active:scale-90" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.445 14.832A1 1 0 0010 14V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4zM16.445 14.832A1 1 0 0018 14V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z" />
                        </svg>
                    </button>

                    <!-- Play/Pausa -->
                    <button id="play-pause-btn"
                        class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 p-6 rounded-full shadow-[0_0_25px_rgba(234,179,8,0.4)] transition-all transform hover:scale-110 active:scale-95">
                        <svg id="play-icon" class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        <svg id="pause-icon" class="w-10 h-10 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1H8a1 1 0 01-1-1V8zm5-1a1 1 0 00-1 1v4a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <!-- Siguiente -->
                    <button id="next-btn" class="text-gray-400 hover:text-white transition-all group">
                        <svg class="w-10 h-10 group-active:scale-90" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4.555 6.168A1 1 0 003 7v6a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4zM12.555 6.168A1 1 0 0011 7v6a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4z" />
                        </svg>
                    </button>

                    <!-- Avanzar 5s -->
                    <button id="skip-forward-btn" class="text-gray-500 hover:text-yellow-500 transition-colors" title="Avanzar 5s">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.934 12.8a1 1 0 000-1.6l-5.334-4A1 1 0 005 8v8a1 1 0 001.6.8l5.334-4zM19.934 12.8a1 1 0 000-1.6l-5.334-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.334-4z" />
                        </svg>
                    </button>
                </div>

                <button id="share-audio-btn"
                    class="w-full bg-white/5 border border-white/10 text-white hover:bg-yellow-500 hover:text-black font-bold py-4 rounded-xl mt-4 transition-all flex items-center justify-center group">
                    <svg class="w-5 h-5 mr-3 group-hover:rotate-12 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    Compartir este Audio
                </button>
            </div>
        </section>

        <!-- Audios de Hoy -->
        <section class="bg-gray-900 text-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-lg font-bold mb-4 flex items-center">
                <span class="w-3 h-3 bg-yellow-500 rounded-full mr-3 shadow-[0_0_8px_#ea7e08]"></span>
                Audios de Hoy
            </h2>
            <ul id="daily-list" class="space-y-2"></ul>
        </section>

        <!-- Historial -->
        <section class="bg-gray-900/80 text-white p-6 rounded-2xl border border-white/5">
            <h2 class="text-sm font-bold mb-4 uppercase tracking-widest opacity-40">Historial</h2>
            <ul id="archive-list" class="space-y-1 text-sm max-h-40 overflow-y-auto custom-scrollbar"></ul>
        </section>

        <div class="text-center text-[10px] text-black/50 font-bold uppercase tracking-widest">
            Sesión: <span id="user-id">...</span>
        </div>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN: El historial estará vacío porque hoy es el día 0 relativo a START_DATE
        const START_DATE = new Date(); 
        START_DATE.setHours(0,0,0,0);
        
        const TRACKS_PER_DAY = 3;

        let audio, tracks = [], currentTrackIndex = 0, isPlaying = false, auth, db, userId = 'default', appId, currentStartIndex = 0;

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        appId = typeof __app_id !== 'undefined' ? __app_id : '1-samuel-devotional';

        const URLS = [
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-1-1-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-1-19-al-28.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-1-a-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-12-a-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-19-al-21.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-22-al-26.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-27-al-36.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-3-1-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-3-11-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-4-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-4-12-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-5-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-13-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-19-al-21.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-7-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-7-13-al-17.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-8-1-al-9.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-8-10-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-9-1-al-9.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-9-10-al-27.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-10-1-al-16.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-10-17-al-27.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-11-1-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-11-11-al-15.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-12-1-al-20.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-12-21-al-25.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-13-1-al-14.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-13-15-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-1-al-14.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-15-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-24-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-32-al-46.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-47-al-52.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-1-al-9.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-10-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-24-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-32-al-35.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-16-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-16-12-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-12-al-24.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-24-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-32-al-40.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-41-al-58.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-18-1-al-5.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-18-6-al-16.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-18-17-al-30.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-19-1-al-8.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-19-9-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-19-19-al-24.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-20-1-al-17.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-20-18-al-42.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-21-1-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-21-11-al-15.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-22-1-al-5.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-22-6-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-22-11-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-23-1-al-13.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-23-13-al-29.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-24-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-24-12-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-25-1-al-13.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-25-14-al-35.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-25-36-al-44.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-26-1-al-25.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-27-1-al-7.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-27-8-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-28-1-al-7.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-28-8-al-25.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-29-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-30-1-al-8.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-30-9-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-31-1-al-6.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-31--8-al-13.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-1-1-al-16.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-1-17-al-21.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-2-1-al-7.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-2-8-al-32.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-3-1-al-5.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-3-6-al-21.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-3-22-al-39.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-4-1-al-12.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-5-1-al-16.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-5-17-al-25.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-6-1-al-10.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-6-11-al-15.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-6-16-al-23.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-7-1-al-17.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-7-18-al-29.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-8-1-al-18.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-9-1-al-13.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-10-1-al-5.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-10-6-al-19.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-11-1-al-4.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-11-5-a-13.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-11-14-al-27.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-12-1-al-12.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-12-13-al-18.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-12-19-al-25.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-12-26-al-31.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-13-1-al-5.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-13-6-al-16.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-13-17-al-22.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-13-23-al-39.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-14-1-al-24.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-14-25-al-33.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-15-1-al-6.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-15-7-al-12.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-15-13-al-23.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-15-24-al-37.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-16-1-al-4.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-16-5-al-14.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-16-15-al-23.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-17-1-al-14.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-17-15-al-21.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-17-22-al-29.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-18-1-al-5.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-18-6-al-18.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-18-19-al-33.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-19-1-al-8.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-19-9-al-14.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-19-15-al-23.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-19-24-al-31.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-19-31-al-40.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-19-41-al-43.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-20-1-al-5.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-20-6-al-13.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-20-14-al-25.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-21-1-al-14.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-21-15-a-17.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-21-18-al-22.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-22-1-al-7.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-22-8-al-20.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-22-21-al-28.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-22-29-al-51.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-23-1-al-7.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-23-8-al-12.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-23-13-al-17.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-23-18-al-23.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-23-24-al-39.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-24-1-al-9.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-24-10-al-17.mp3",
          "https://archive.org/download/movimiento-blindaje-2-Samuel/2%20Samuel/Movimiento-Blindaje--2-Samuel-24-18-al-25.mp3"
        ];

        function extractTrackName(url) {
            const decodedUrl = decodeURIComponent(url);
            const filename = decodedUrl.split('/').pop().replace('.mp3', '');
            const match = filename.match(/1-Samuel-(\d+)-(\d+)-(?:al|a|--)?-(\d+)/);
            if (match) return `1 Samuel ${match[1]}:${match[2]}-${match[3]}`;
            return filename.replace(/Movimiento-Blindaje--|Movimiento-Blindaje-/g, '').replace(/-/g, ' ');
        }

        const ALL_TRACKS = URLS.map(url => ({ name: extractTrackName(url), url }));

        const playPauseBtn = document.getElementById('play-pause-btn'),
              playIcon = document.getElementById('play-icon'),
              pauseIcon = document.getElementById('pause-icon'),
              prevBtn = document.getElementById('prev-btn'),
              nextBtn = document.getElementById('next-btn'),
              skipBackwardBtn = document.getElementById('skip-backward-btn'),
              skipForwardBtn = document.getElementById('skip-forward-btn'),
              shareAudioBtn = document.getElementById('share-audio-btn'),
              trackNameEl = document.getElementById('track-name'),
              currentTimeEl = document.getElementById('current-time'),
              totalTimeEl = document.getElementById('total-time'),
              seekBar = document.getElementById('seek-bar'),
              dailyListEl = document.getElementById('daily-list'),
              archiveListEl = document.getElementById('archive-list'),
              userIdEl = document.getElementById('user-id'),
              devotionDayInfoEl = document.getElementById('devotion-day-info');

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function getBusinessDaysCount(start, end) {
            let count = 0;
            const cur = new Date(start); cur.setHours(0,0,0,0);
            const fin = new Date(end); fin.setHours(0,0,0,0);
            while (cur <= fin) {
                if (cur.getDay() !== 0 && cur.getDay() !== 6) count++;
                cur.setDate(cur.getDate() + 1);
            }
            return count;
        }

        function calculateCurrentDayIndex() {
            const today = new Date();
            let bizDays = getBusinessDaysCount(START_DATE, today) - 1;
            if (bizDays < 0) bizDays = 0;
            const startIndex = bizDays * TRACKS_PER_DAY;
            devotionDayInfoEl.textContent = `Día ${bizDays + 1} de Devocional (1 Samuel)`;
            return startIndex >= ALL_TRACKS.length ? Math.floor((ALL_TRACKS.length-1)/3)*3 : startIndex;
        }

        async function saveState() {
            if (!db || !userId) return;
            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/playlist_data`, 'user_state'), {
                    currentTrackIndex,
                    lastPlayedTime: audio ? audio.currentTime : 0
                }, { merge: true });
            } catch (e) { console.error(e); }
        }

        function renderPlaylist() {
            dailyListEl.innerHTML = ''; archiveListEl.innerHTML = '';
            const dailyLabels = ["Desayuno", "Almuerzo", "Cena"];
            
            let hasHistory = false;

            ALL_TRACKS.forEach((track, i) => {
                const isDaily = i >= currentStartIndex && i < currentStartIndex + 3;
                const isHistory = i < currentStartIndex;
                const isCurrent = i === currentTrackIndex;
                
                const li = document.createElement('li');
                li.className = `flex justify-between items-center p-4 rounded-xl cursor-pointer transition-all ${isCurrent ? 'bg-yellow-500 text-black font-black scale-[1.02] shadow-lg' : 'bg-gray-800/40 hover:bg-gray-800 text-gray-300'}`;
                
                let label = isDaily ? `<span class="text-[10px] uppercase opacity-60 block">${dailyLabels[i - currentStartIndex]}</span>` : '';
                li.innerHTML = `<div>${label}${track.name}</div>${isCurrent ? '<span>▶</span>' : ''}`;
                
                li.onclick = () => { currentTrackIndex = i; loadTrack(i); playTrack(); };
                
                if (isDaily) dailyListEl.appendChild(li);
                else if (isHistory) {
                    archiveListEl.appendChild(li);
                    hasHistory = true;
                }
            });

            if (!hasHistory) {
                archiveListEl.innerHTML = '<li class="text-xs opacity-30 italic text-center py-4">El historial se llenará con los audios de los días anteriores</li>';
            }
        }

        function loadTrack(i) {
            currentTrackIndex = i;
            const track = ALL_TRACKS[i];
            audio.src = track.url;
            trackNameEl.textContent = track.name;
            audio.load();
            renderPlaylist();
            saveState();
        }

        function playTrack() {
            audio.play().then(() => {
                isPlaying = true;
                playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden');
                document.getElementById('play-pause-btn').classList.add('play-pulse');
            }).catch(e => console.error(e));
        }

        function pauseTrack() {
            audio.pause(); isPlaying = false;
            playIcon.classList.remove('hidden'); pauseIcon.classList.add('hidden');
            document.getElementById('play-pause-btn').classList.remove('play-pulse');
            saveState();
        }

        function initializePlayer(idx, time) {
            audio = new Audio();
            audio.ontimeupdate = () => {
                if (audio.duration) {
                    seekBar.value = (audio.currentTime / audio.duration) * 100;
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                }
            };
            audio.onloadedmetadata = () => {
                totalTimeEl.textContent = formatTime(audio.duration);
                if (time > 0) audio.currentTime = time;
            };
            audio.onended = () => {
                if (currentTrackIndex < currentStartIndex + 2) {
                    currentTrackIndex++; loadTrack(currentTrackIndex); playTrack();
                }
            };

            playPauseBtn.onclick = () => isPlaying ? pauseTrack() : playTrack();
            prevBtn.onclick = () => { if(currentTrackIndex > 0){ currentTrackIndex--; loadTrack(currentTrackIndex); playTrack(); }};
            nextBtn.onclick = () => { if(currentTrackIndex < ALL_TRACKS.length - 1){ currentTrackIndex++; loadTrack(currentTrackIndex); playTrack(); }};
            skipBackwardBtn.onclick = () => audio.currentTime -= 5;
            skipForwardBtn.onclick = () => audio.currentTime += 5;
            seekBar.oninput = () => { audio.currentTime = (seekBar.value / 100) * audio.duration; };
            
            shareAudioBtn.onclick = () => {
                const url = window.location.href.split('?')[0] + '?trackIndex=' + currentTrackIndex;
                if (navigator.share) navigator.share({ title: trackNameEl.textContent, url });
                else {
                    const el = document.createElement('textarea'); el.value = url; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
                    alert("Enlace copiado.");
                }
            };

            loadTrack(idx);
        }

        async function init() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app); auth = getAuth(app);
            await setPersistence(auth, browserLocalPersistence);
            initialAuthToken ? await signInWithCustomToken(auth, initialAuthToken) : await signInAnonymously(auth);

            onAuthStateChanged(auth, u => {
                if (u) {
                    userId = u.uid; userIdEl.textContent = userId.substring(0,8);
                    currentStartIndex = calculateCurrentDayIndex();
                    const urlParams = new URLSearchParams(window.location.search);
                    const sharedIdx = urlParams.get('trackIndex');
                    
                    onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/playlist_data`, 'user_state'), s => {
                        const d = s.exists() ? s.data() : {};
                        const idx = sharedIdx !== null ? parseInt(sharedIdx) : (d.currentTrackIndex !== undefined ? d.currentTrackIndex : currentStartIndex);
                        if (!audio) initializePlayer(idx, sharedIdx ? 0 : (d.lastPlayedTime || 0));
                    });
                }
            });
        }
        window.onload = init;
    </script>
</body>
</html>
