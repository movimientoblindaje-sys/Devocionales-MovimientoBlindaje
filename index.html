<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devocional Diario - 1 Samuel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #ffc61a; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: white; cursor: pointer; margin-top: -6px; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .large-logo { height: auto; max-height: 250px; width: auto; max-width: 100%; }
        .play-pulse { animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-ring { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.9; } }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <header class="text-center mb-8">
        <img id="logo-img" src="logo-blindaje.png" alt="Logo Blindaje" class="mx-auto large-logo shadow-2xl mb-6 rounded-lg">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider uppercase drop-shadow-lg">Devocional diario</h1>
        <p id="devotion-day-info" class="text-sm font-semibold text-gray-800 mt-2 italic">Serie Completa: 1 Samuel</p>
    </header>

    <main class="flex flex-col gap-6 max-w-4xl mx-auto">
        <!-- Reproductor Principal -->
        <section class="bg-gray-900 text-white p-6 md:p-10 rounded-2xl shadow-2xl border border-white/5">
            <h2 class="text-xs uppercase tracking-[0.2em] font-black text-yellow-500 mb-6 text-center opacity-80">Reproductor Blindaje</h2>
            <div class="space-y-6">
                <div class="text-center mb-8">
                    <p id="track-name" class="text-2xl md:text-3xl font-bold truncate px-2 text-yellow-500">Seleccione un audio</p>
                    <p class="text-sm text-gray-400 font-medium mt-1 uppercase tracking-widest">1 Samuel • Movimiento Blindaje</p>
                </div>
                <div class="flex items-center space-x-3">
                    <span id="current-time" class="text-xs font-mono w-10 opacity-60">0:00</span>
                    <input type="range" id="seek-bar" value="0" min="0" max="100" class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                    <span id="total-time" class="text-xs font-mono w-10 opacity-60">0:00</span>
                </div>
                <div class="flex justify-center items-center space-x-4 md:space-x-8 py-4">
                    <button id="skip-back" class="text-gray-500 hover:text-yellow-500 transition-colors"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0019 16V8a1 1 0 00-1.6-.8l-5.334 4zM4.066 11.2a1 1 0 000 1.6l5.334 4A1 1 0 0011 16V8a1 1 0 00-1.6-.8l-5.334 4z"/></svg></button>
                    <button id="prev-btn" class="text-gray-400 hover:text-white transition-all"><svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4zM16.445 14.832A1 1 0 0018 14V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"/></svg></button>
                    <button id="play-pause-btn" class="bg-yellow-500 hover:bg-yellow-400 text-gray-900 p-6 rounded-full shadow-lg transition-all transform hover:scale-110 active:scale-95">
                        <svg id="play-icon" class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/></svg>
                        <svg id="pause-icon" class="w-10 h-10 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1H8a1 1 0 01-1-1V8zm5-1a1 1 0 00-1 1v4a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2z"/></svg>
                    </button>
                    <button id="next-btn" class="text-gray-400 hover:text-white transition-all"><svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path d="M4.555 6.168A1 1 0 003 7v6a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4zM12.555 6.168A1 1 0 0011 7v6a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4z"/></svg></button>
                    <button id="skip-forw" class="text-gray-500 hover:text-yellow-500 transition-colors"><svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.934 12.8a1 1 0 000-1.6l-5.334-4A1 1 0 005 8v8a1 1 0 001.6.8l5.334-4zM19.934 12.8a1 1 0 000-1.6l-5.334-4A1 1 0 0013 8v8a1 1 0 001.6.8l5.334-4z"/></svg></button>
                </div>
                <button id="share-btn" class="w-full bg-white/5 border border-white/10 text-white hover:bg-yellow-500 hover:text-black font-bold py-4 rounded-xl transition-all flex items-center justify-center">Compartir este Audio</button>
            </div>
        </section>

        <!-- Lista de Audios -->
        <section class="bg-gray-900 text-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-lg font-bold mb-4 flex items-center"><span class="w-3 h-3 bg-yellow-500 rounded-full mr-3"></span>Audios de Hoy</h2>
            <ul id="daily-list" class="space-y-2"></ul>
        </section>

        <!-- Historial -->
        <section class="bg-gray-900/80 text-white p-6 rounded-2xl border border-white/5">
            <h2 class="text-sm font-bold mb-4 uppercase tracking-widest opacity-40">Historial</h2>
            <ul id="archive-list" class="space-y-1 text-sm max-h-60 overflow-y-auto custom-scrollbar"></ul>
        </section>

        <div class="text-center text-[10px] text-black/50 font-bold uppercase tracking-widest">Sesión: <span id="u-id">...</span></div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURACIÓN DE FECHA: Ajustamos para que HOY sea el día 1.
        const START_DATE = new Date(); 
        START_DATE.setHours(0,0,0,0);
        
        const URLS = [
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-1-1-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-1-19-al-28.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-1-a-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-12-a-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-19-al-21.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-22-al-26.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-27-al-36.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-3-1-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-3-11-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-4-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-4-12-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-5-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-13-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-19-al-21.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-7-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-7-13-al-17.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-8-1-al-9.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-8-10-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-9-1-al-9.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje-1-Samuel-9-10-al-27.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-10-1-al-16.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-10-17-al-27.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-11-1-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-11-11-al-15.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-12-1-al-20.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-12-21-al-25.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-13-1-al-14.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-13-15-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-1-al-14.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-15-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-24-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-32-al-46.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-14-47-al-52.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-1-al-9.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-10-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-24-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-15-32-al-35.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-16-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-16-12-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-12-al-24.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-24-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-32-al-40.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-17-41-al-58.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-18-1-al-5.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-18-6-al-16.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-18-17-al-30.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-19-1-al-8.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-19-9-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-19-19-al-24.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-20-1-al-17.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-20-18-al-42.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-21-1-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-21-11-al-15.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-22-1-al-5.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-22-6-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-22-11-al-23.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-23-1-al-13.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-23-13-al-29.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-24-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-24-12-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-25-1-al-13.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-25-14-al-35.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-25-36-al-44.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-26-1-al-25.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-27-1-al-7.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-27-8-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-28-1-al-7.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-28-8-al-25.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-29-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-30-1-al-8.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-30-9-al-31.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-31-1-al-6.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-31--8-al-13.mp3"
        ];
        
        const extractName = u => {
            const d = decodeURIComponent(u).split('/').pop().replace('.mp3', '');
            const m = d.match(/1-Samuel-(\d+)-(\d+)-(?:al|a|--)?-(\d+)/);
            return m ? `1 Samuel ${m[1]}:${m[2]}-${m[3]}` : d.replace(/Movimiento-Blindaje--|Movimiento-Blindaje-/g, '').replace(/-/g, ' ');
        };
        const ALL = URLS.map(u => ({ n: extractName(u), u }));
        
        let audio = new Audio(), curIdx = 0, playing = false, db, uid, appId = typeof __app_id !== 'undefined' ? __app_id : '1-samuel-dev';
        const $ = id => document.getElementById(id);
        const format = s => `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}`;

        function render() {
            $('daily-list').innerHTML = ''; $('archive-list').innerHTML = '';
            
            // Cálculo de días relativos a START_DATE
            const now = new Date();
            now.setHours(0,0,0,0);
            const diffTime = now - START_DATE;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Lógica de rotación de 3 audios por día
            const dayStart = (diffDays * 3) % ALL.length;
            
            $('devotion-day-info').textContent = `Día ${diffDays + 1} de Devocional`;
            
            ALL.forEach((t, i) => {
                const isD = i >= dayStart && i < dayStart + 3;
                const isH = i < dayStart;
                
                const li = document.createElement('li');
                li.className = `flex justify-between p-4 rounded-xl cursor-pointer transition-all ${i===curIdx ? 'bg-yellow-500 text-black font-black scale-[1.02]' : 'bg-gray-800/40 text-gray-300 hover:bg-gray-800'}`;
                
                let label = '';
                if(isD) label = `<span class='text-[10px] block opacity-60'>${["Desayuno","Almuerzo","Cena"][i-dayStart]}</span>`;
                
                li.innerHTML = `<div>${label}${t.n}</div>${i===curIdx ? '<span>▶</span>' : ''}`;
                li.onclick = () => load(i, true);
                
                if (isD) $('daily-list').appendChild(li);
                else if (isH) $('archive-list').appendChild(li);
            });
            
            if (!$('archive-list').hasChildNodes()) {
                $('archive-list').innerHTML = '<li class="opacity-30 italic text-center py-4">El historial se llenará mañana</li>';
            }
        }

        function load(i, p=false) {
            curIdx = i; audio.src = ALL[i].u; $('track-name').textContent = ALL[i].n; render();
            if (p) audio.play().then(() => { playing=true; ui(); });
            if(uid) setDoc(doc(db, `artifacts/${appId}/users/${uid}/playlist_data`, 'state'), { curIdx, time: audio.currentTime }, { merge: true });
        }

        const ui = () => {
            $('play-icon').classList.toggle('hidden', playing);
            $('pause-icon').classList.toggle('hidden', !playing);
            $('play-pause-btn').classList.toggle('play-pulse', playing);
        };

        audio.ontimeupdate = () => { if(audio.duration){ $('seek-bar').value = (audio.currentTime/audio.duration)*100; $('current-time').textContent = format(audio.currentTime); }};
        audio.onloadedmetadata = () => $('total-time').textContent = format(audio.duration);
        audio.onended = () => { if(curIdx < ALL.length-1) load(curIdx+1, true); };

        $('play-pause-btn').onclick = () => { playing ? audio.pause() : audio.play(); playing = !playing; ui(); };
        $('prev-btn').onclick = () => curIdx > 0 && load(curIdx-1, true);
        $('next-btn').onclick = () => curIdx < ALL.length-1 && load(curIdx+1, true);
        $('skip-back').onclick = () => audio.currentTime -= 5;
        $('skip-forw').onclick = () => audio.currentTime += 5;
        $('seek-bar').oninput = () => audio.currentTime = ($('seek-bar').value/100)*audio.duration;
        $('share-btn').onclick = () => {
            const url = window.location.href.split('?')[0] + '?t=' + curIdx;
            if(navigator.share) navigator.share({title: ALL[curIdx].n, url});
            else { const t = document.createElement('input'); t.value = url; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); }
        };

        (async () => {
            const app = initializeApp(typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});
            db = getFirestore(app); const auth = getAuth(app);
            const u = (await signInAnonymously(auth)).user;
            uid = u.uid; $('u-id').textContent = uid.slice(0,8);
            
            // Re-calcular inicio para carga inicial
            const now = new Date(); now.setHours(0,0,0,0);
            const diffDays = Math.floor((now - START_DATE) / (1000 * 60 * 60 * 24));
            const dayStart = (diffDays * 3) % ALL.length;

            onSnapshot(doc(db, `artifacts/${appId}/users/${uid}/playlist_data`, 'state'), s => {
                const d = s.data() || {}, tParam = new URLSearchParams(location.search).get('t');
                if (!audio.src) { 
                    load(tParam ? parseInt(tParam) : (d.curIdx ?? dayStart)); 
                    if(d.time && !tParam) audio.currentTime = d.time; 
                }
            });
        })();
    </script>
</body>
</html>
