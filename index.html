<!-- 
  Reproductor de Audio Devocional Diario
  Funcionalidad:
    - Rotación diaria de 3 audios (Desayuno, Almuerzo, Cena)
    - Persistencia de estado (índice, volumen, tiempo) en Firestore.
    - Botones de avance/retroceso de 5 segundos.
    - Compartir enlace directo al audio actual (vía parámetro URL).
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devocional Diario - Blindaje</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffc61a;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a4a4a;
            border-radius: 10px;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <header class="text-center mb-8">
        <img id="logo-img" src="logo-blindaje.png"
            onerror="this.src='https://placehold.co/400x200/000000/FFFFFF?text=BLINDAJE'" alt="Logo Blindaje"
            class="mx-auto h-32 md:h-44 object-contain mb-4">
        <h1 class="text-3xl md:text-5xl font-extrabold tracking-wider uppercase drop-shadow-lg text-black">Devocional diario</h1>
    </header>

    <main class="flex flex-col gap-6 max-w-4xl mx-auto">
        
        <!-- REPRODUCTOR PRINCIPAL -->
        <section class="bg-gray-900 text-white p-6 md:p-8 rounded-xl shadow-2xl border-b-4 border-yellow-600">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-yellow-500 uppercase italic">Reproductor</h2>
            <div class="space-y-4">
                <div class="text-center mb-6">
                    <p id="track-name" class="text-2xl font-semibold truncate px-2 text-yellow-400 italic">Cargando...</p>
                    <p class="text-sm text-gray-400 uppercase tracking-widest">Movimiento Blindaje</p>
                </div>

                <div class="flex items-center space-x-2">
                    <span id="current-time" class="text-xs font-mono w-10 text-gray-400">0:00</span>
                    <input type="range" id="seek-bar" value="0" min="0" max="100"
                        class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500">
                    <span id="total-time" class="text-xs font-mono w-10 text-gray-400">0:00</span>
                </div>

                <div class="flex justify-center items-center space-x-4 md:space-x-8 pt-4">
                    <button id="prev-btn" class="text-white hover:text-yellow-400 transition-transform active:scale-90">
                        <svg class="w-8 h-8 md:w-10 md:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                        </svg>
                    </button>

                    <button id="play-pause-btn" class="bg-yellow-500 hover:bg-yellow-400 text-black p-5 rounded-full shadow-xl transition-all transform hover:scale-105 active:scale-95">
                        <svg id="play-icon" class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        <svg id="pause-icon" class="w-10 h-10 hidden" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1H8a1 1 0 01-1-1V8zM11 8a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 01-1-1V8z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <button id="next-btn" class="text-white hover:text-yellow-400 transition-transform active:scale-90">
                        <svg class="w-8 h-8 md:w-10 md:h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

                <div class="flex items-center space-x-3 pt-6 border-t border-gray-800">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                    <input type="range" id="volume-bar" value="100" min="0" max="100" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-600">
                    <span id="volume-display" class="text-xs font-mono w-8 text-gray-500">100%</span>
                </div>
            </div>

            <button id="share-audio-btn" class="w-full bg-yellow-500 text-black font-black py-4 px-4 rounded-lg mt-6 transition-all flex justify-center items-center gap-2 uppercase hover:bg-yellow-400 active:scale-95 shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                <span id="share-btn-text">Copiar enlace del audio</span>
            </button>
        </section>

        <!-- AUDIOS DE HOY (FIJO) -->
        <section class="bg-gray-900 text-white p-6 rounded-xl shadow-2xl border border-gray-800">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2 text-yellow-500 uppercase italic">Audios de Hoy</h2>
            <ul id="daily-list" class="divide-y divide-gray-800">
                <!-- Se llenará dinámicamente -->
            </ul>
        </section>

        <!-- HISTORIAL (REPLEGABLE) -->
        <section class="bg-gray-900 text-white rounded-xl shadow-2xl overflow-hidden border border-gray-800">
            <button id="history-toggle" class="w-full p-6 flex justify-between items-center bg-gray-900 hover:bg-gray-800 transition-colors">
                <h2 class="text-xl font-bold uppercase italic text-gray-300">Historial (1 Samuel)</h2>
                <svg id="history-icon" class="w-6 h-6 transform transition-transform" fill="currentColor" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg>
            </button>
            <div id="history-container" class="hidden border-t border-gray-800">
                <ul id="history-list" class="divide-y divide-gray-800 max-h-80 overflow-y-auto custom-scrollbar">
                    <!-- Se llenará dinámicamente -->
                </ul>
            </div>
        </section>

    </main>

    <script type="module">
        /**
         * LÓGICA DE FECHA Y PAUSA:
         * Inicio: Viernes 2 de Enero de 2026.
         * Pausa: Sábados y Domingos no se avanza el plan.
         */
        const START_DATE = new Date(2026, 0, 2); 
        
        const RAW_URLS = [
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-1-1-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-1-19-al-28.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-1-a-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-12-a-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-19-al-21.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-22-al-26.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-2-27-al-36.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-3-1-al-10.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-3-11-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-4-1-al-11.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-4-12-al-22.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-5-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-1-al-12.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-13-al-18.mp3",
            "https://archive.org/download/movimiento-blindaje-1-samuel-audios/1%20Samuel%20Terminado%20mp3/Movimiento-Blindaje--1-Samuel-6-19-al-21.mp3"
        ];

        const getStudyDaysPassed = () => {
            const start = new Date(START_DATE);
            const today = new Date();
            start.setHours(0,0,0,0);
            today.setHours(0,0,0,0);
            if (today < start) return 0;
            let studyDays = 0;
            let current = new Date(start);
            while (current < today) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    studyDays++;
                }
                current.setDate(current.getDate() + 1);
            }
            return studyDays;
        };

        const studyDay = getStudyDaysPassed();
        const currentDailyStartIdx = studyDay * 3;

        const cleanName = (url) => {
            let n = decodeURIComponent(url.split('/').pop()).replace('.mp3', '');
            return n.replace('Movimiento-Blindaje--', '').replace(/-/g, ' ');
        };

        const allTracks = RAW_URLS.map((u, i) => ({ id: i, name: cleanName(u), url: u }));
        
        let dailyTracks = allTracks.slice(currentDailyStartIdx, currentDailyStartIdx + 3);
        if (dailyTracks.length === 0) dailyTracks = allTracks.slice(-3);

        const historyTracks = allTracks.slice(0, currentDailyStartIdx);

        let audio = new Audio();
        let isPlaying = false;
        let currentTrack = null;

        const playPauseBtn = document.getElementById('play-pause-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const trackNameEl = document.getElementById('track-name');
        const seekBar = document.getElementById('seek-bar');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const volumeBar = document.getElementById('volume-bar');

        const formatTime = (s) => isNaN(s) ? "0:00" : `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2, '0')}`;

        function loadTrack(t) {
            if (!t) return;
            currentTrack = t;
            audio.src = t.url;
            trackNameEl.textContent = t.name;
            renderLists();
        }

        function togglePlay() {
            if (!audio.src) return;
            if (isPlaying) {
                audio.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            } else {
                audio.play();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }
            isPlaying = !isPlaying;
        }

        function renderLists() {
            const dailyList = document.getElementById('daily-list');
            dailyList.innerHTML = '';
            const labels = ["Desayuno", "Almuerzo", "Cena"];
            
            dailyTracks.forEach((t, i) => {
                const active = currentTrack && currentTrack.id === t.id;
                const li = document.createElement('li');
                li.className = `p-4 cursor-pointer border-l-4 transition-all ${active ? 'bg-yellow-600/30 border-yellow-500 font-bold' : 'hover:bg-gray-800 border-transparent text-gray-400'}`;
                li.innerHTML = `<div class="flex items-center"><span class="text-yellow-500 text-xs font-black uppercase mr-3 w-20">${labels[i] || 'Extra'}</span> <span class="flex-1">${t.name}</span></div>`;
                li.onclick = () => { loadTrack(t); togglePlay(); };
                dailyList.appendChild(li);
            });

            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            [...historyTracks].reverse().forEach(t => {
                const active = currentTrack && currentTrack.id === t.id;
                const li = document.createElement('li');
                li.className = `p-3 cursor-pointer transition-colors ${active ? 'bg-gray-800 text-yellow-500 font-bold' : 'hover:bg-gray-800/50 text-gray-500'}`;
                li.innerHTML = `<span class="text-sm">${t.name}</span>`;
                li.onclick = () => { loadTrack(t); togglePlay(); };
                historyList.appendChild(li);
            });
        }

        playPauseBtn.onclick = togglePlay;
        document.getElementById('next-btn').onclick = () => {
            const idx = allTracks.findIndex(t => t.id === currentTrack.id);
            if (idx >= 0 && idx < currentDailyStartIdx + 2 && idx < allTracks.length - 1) {
                loadTrack(allTracks[idx + 1]);
                if (isPlaying) audio.play();
            }
        };
        document.getElementById('prev-btn').onclick = () => {
            const idx = allTracks.findIndex(t => t.id === currentTrack.id);
            if (idx > 0) {
                loadTrack(allTracks[idx - 1]);
                if (isPlaying) audio.play();
            }
        };

        audio.ontimeupdate = () => {
            seekBar.value = (audio.currentTime / audio.duration) * 100 || 0;
            currentTimeEl.textContent = formatTime(audio.currentTime);
        };
        audio.onloadedmetadata = () => totalTimeEl.textContent = formatTime(audio.duration);
        audio.onended = () => {
            const lastDailyId = dailyTracks[dailyTracks.length - 1].id;
            if (currentTrack.id === lastDailyId) {
                isPlaying = false;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            } else {
                document.getElementById('next-btn').click();
            }
        };

        seekBar.oninput = () => audio.currentTime = (seekBar.value / 100) * audio.duration;
        volumeBar.oninput = () => {
            audio.volume = volumeBar.value / 100;
            document.getElementById('volume-display').textContent = volumeBar.value + "%";
        };

        // ACCIÓN DEL BOTÓN COMPARTIR CORREGIDA
        document.getElementById('share-audio-btn').onclick = async () => {
            if (!currentTrack) return;
            
            // 1. Generar la URL con el track ID
            const baseUrl = window.location.href.split('?')[0];
            const shareUrl = `${baseUrl}?track=${currentTrack.id}`;
            
            // 2. Intentar compartir nativamente (especialmente en móviles)
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Devocional Blindaje',
                        text: `Escucha: ${currentTrack.name}`,
                        url: shareUrl
                    });
                    return; // Si funcionó el menú nativo, salimos
                } catch (e) {
                    console.log("Compartir nativo falló o fue cancelado");
                }
            }

            // 3. Fallback: Copiar al portapapeles y avisar al usuario
            const dummy = document.createElement('input');
            document.body.appendChild(dummy);
            dummy.value = shareUrl;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);

            const btnText = document.getElementById('share-btn-text');
            btnText.innerText = "¡ENLACE COPIADO!";
            setTimeout(() => btnText.innerText = "Copiar enlace del audio", 2500);
        };

        const historyToggle = document.getElementById('history-toggle');
        const historyContainer = document.getElementById('history-container');
        const historyIcon = document.getElementById('history-icon');

        historyToggle.onclick = () => {
            const isHidden = historyContainer.classList.contains('hidden');
            if (isHidden) {
                historyContainer.classList.remove('hidden');
                historyIcon.classList.add('rotate-180');
            } else {
                historyContainer.classList.add('hidden');
                historyIcon.classList.remove('rotate-180');
            }
        };

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const trackIdParam = params.get('track');
            if (trackIdParam !== null) {
                const tId = parseInt(trackIdParam);
                if (!isNaN(tId) && tId >= 0 && tId < allTracks.length) {
                    loadTrack(allTracks[tId]);
                } else {
                    loadTrack(dailyTracks[0]);
                }
            } else {
                loadTrack(dailyTracks[0]);
            }
        };
    </script>
</body>
</html>
